pipeline {
  agent any
  checkout scm

  environment {
    SECRET_KEY = credentials('jenkins-aws-secret-key-id')
    ACCESS_KEY = credentials('jenkins-aws-secret-access-key')
    JWT_SECRET = credentials('jenkins-jwt-secret')
    REFRESH_SECRET = credentials('jenkins-refresh-secret')
  }
  stages {
    stage('Build') {
      steps {
        echo 'Building...'
        docker build -t rest-api .
        docker run \
          -e JWT_SECRET=$JWT_SECRET \
          -e REFRESH_SECRET=$REFRESH_SECRET \
          -e ACCESS_KEY=$ACCESS_KEY \
          -e SECRET_KEY=$SECRET_KEY \
          rest-api:latest
      }
    }
    stage('Test') {
      steps {
        echo 'Testing...'
        docker run \
          -e JWT_SECRET=$JWT_SECRET \
          -e REFRESH_SECRET=$REFRESH_SECRET \
          -e ACCESS_KEY=$ACCESS_KEY \
          -e SECRET_KEY=$SECRET_KEY \
          --entrypoint ./scripts/test.sh \
          rest-api:latest
      }
    }
    stage('Deploy') {
      when {
        branch 'master'
        expression {
          currentBuild.result == null || currentBuild.result == 'SUCCESS'
        }
      }
      steps {
        echo 'Deploying...'
      }
    }
  }
}